---
title: 비디오 업로드 기능 만들기(Web) 2탄
publishedAt: '2023-06-31'
summary: 기획 그만바꿔 기간 늘려주던가.
category: Dev
---

## 개요

대표님의 급작스러운 오더로 업로드 제한 용량이 5gb로 변경되었습니다. 그 과정에서 만난 이슈와 개선내용을 다룹니다.

## 목표

**5gb** 비디오 업로드 기능 개발

## 과정 및 이슈

1gb 이상 비디오 업로드를 테스트하며 여러 이슈를 만났으며, 그중 가장 **치명적인 이슈**는 2가지였습니다.

1. **1gb 이상 비디오** 업로드 시 **2분 이상 소요**되었고, 용량이 커질수록 **속도가 크게 저하**되었습니다.
2. 1.5gb 이상 비디오 업로드 시 간헐적으로 **네트워크 오류로 요청이 끊기고**, 대용량 파일을 서버로 한번에 업로드하기 때문에 **OOM(Out of Memory Exception)** 이슈가 발생했습니다.

이슈를 개선하고 기능을 구현하기 위한 필요한 요구사항을 정리했습니다.

- 브라우저에서 대용량 파일을 서버로 한번에 업로드하는게 아닌, **분할로 끊어서 업로드**해야함
- 업로드 도중 요청이 끊겨도, **재요청**을 하고 끊긴 위치부터 **재업로드가 가능**해야함
- 라이브러리를 사용한다면, 백엔드와 프론트 함께 사용면 좋음

### Tus-Protocol

여러가지 해결책을 찾아본 결과 위의 요구사항을 충족하는
라이브러리([tus-js-client](https://github.com/tus/tus-js-client), [tus-java-client](https://github.com/tus/tus-java-client))가 있었고
모두 [Tus Protocol](https://tus.io/)을 기반으로 구현되어있었습니다.

#### 분할 업로드

tus를 선택한 가장 큰 이유는 **분할 업로드**를 통해 **OOM이슈를 빠르고 쉽게 해결 가능**하기 때문입니다.
백엔드 팀원과 함께 테스트해본 결과, form으로 업로드하는 일반적인 방식과 tus를 적용한 방식의 **성능차이가 매우 뚜렷**했습니다.
더불어 tus를 선택한 타 개발자들의 비교 자료까지 확인 후 적용하게 되었습니다.

일단 **form**으로 업로드하는 방식은 5gb 파일을 올렸을때 **OOM에러**가 발생합니다.

<p align='center'>
  <img src='/blog/oom.png' alt='oom' />
</p>

아래는 1gb 파일을 기준으로 성능 비교 결과입니다.<br/>

<p align='center'>
  <img src='/blog/tus-form.png' alt='oom' />
</p>

출처:[꾸준함](https://jaimemin.tistory.com/2194)

**tus를 적용한 방식**은 대용량 파일을 업로드 시 **청크 단위로 분할 업로드**를 하기 때문에 tus를 적용한 방식이 **더 많이 HTTP요청**을 합니다.
하지만 **JVM Heap Memory는 전혀 증가하지 않는 것**을 확인할 수 있습니다.<br/>

반면, **form**으로 업로드하는 방식은 단 한번의 HTTP요청으로 업로드되기 때문에 Rate의 변화는 없지만, **JVM Heap Memory가 급격히 증가**한 모습을 확인할 수 있습니다.

정리하자면 tus 방식은 5gb 파일도 **메모리 증가가 없지만**, tus를 적용하지 않은 방식은 1gb 파일도 **메모리를 많이 사용**하고 필요로합니다.
